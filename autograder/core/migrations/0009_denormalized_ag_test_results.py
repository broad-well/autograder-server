# Generated by Django 2.0.1 on 2018-05-22 23:19

import autograder.core.fields
import django.contrib.postgres.fields.jsonb
from django.db import migrations

from autograder.core.submission_feedback import update_denormalized_ag_test_results


def set_denormalized_results(app, apps, schema_editor):
    Submission = apps.get_model('core', 'Submission')
    for submission in Submission.objects.all():
        update_denormalized_ag_test_results(submission.pk)


class Migration(migrations.Migration):

    dependencies = [
        ('core', '0008_submission_project_field'),
    ]

    operations = [
        migrations.AddField(
            model_name='submission',
            name='denormalized_ag_test_results',
            field=django.contrib.postgres.fields.jsonb.JSONField(default=dict, help_text='Stores denormalized AG test results in order to avoid \n                     expensive joins when getting submission result feedback.\n                     To update this field, use \n                     autograder.core.submission_feedback.update_denormalized_ag_test_results\n                     \n                     Data format: \n{\n    "<ag test suite pk>": {\n        <ag test suite result data>,\n        "ag_test_case_results": {\n            "<ag test case pk>": {\n                <ag test case result data>,\n                "ag_test_command_results": <ag test command result data>\n            }\n        }\n    }\n}\n        '),
        ),
        migrations.AlterField(
            model_name='submission',
            name='submitted_filenames',
            field=autograder.core.fields.StringArrayField(allow_empty_strings=False, blank=True, default=list, help_text='The names of files that were submitted,\n                     excluding those that were discarded.', max_string_length=255, size=None, string_validators=[], strip_strings=False),
        ),

        migrations.RunPython(set_denormalized_results,
                             reverse_code=lambda apps, schema_editor: None)
    ]
