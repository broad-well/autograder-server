<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags (Bootstrap) -->


    <title>The Autograder</title>

    {% load staticfiles %}

    <!-- JQuery -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>

    <!-- JQuery Cookie -->
    <script src="{% static 'autograder/jquery-cookie/jquery.cookie.js' %}"></script>

    <!-- Google Authentication -->
    <meta name="google-signin-scope" content="profile email">
    <meta name="google-signin-client_id" content="358440655746-bl5ig1es62n6n4oho525l4f58fgl367c.apps.googleusercontent.com">

    <script src="https://apis.google.com/js/platform.js" async defer></script>

    <!-- code prettify -->
    <script src="https://google-code-prettify.googlecode.com/svn/loader/run_prettify.js"></script>

    <!-- csrf protection -->
    <script id='csrf-setup' type="text/javascript">
        // source: https://docs.djangoproject.com/en/1.7/ref/contrib/csrf/#ajax
        // var csrftoken = $.cookie('csrftoken');
        function csrfSafeMethod(method)
        {
            // these HTTP methods do not require CSRF protection
            return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
        }
        $.ajaxSetup({
            beforeSend: function(xhr, settings) {
                if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                    xhr.setRequestHeader("X-CSRFToken", $.cookie('csrftoken'));
                }
            }
        });
    </script>

    <!-- Boostrap -->

    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">

    <!-- Optional theme -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap-theme.min.css">

    <!-- Latest compiled and minified JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js" async defer></script>

    <!-- /Bootstrap -->

    <!-- File Upload -->

    <!-- Generic page styles -->
    <link rel="stylesheet" href="{% static 'autograder/file-upload/css/style.css' %}">
    <!-- blueimp Gallery styles -->
    <!--<link rel="stylesheet" href="//blueimp.github.io/Gallery/css/blueimp-gallery.min.css">-->
    <!-- CSS to style the file input field as button and adjust the Bootstrap progress bars -->
    <link rel="stylesheet" href="{% static 'autograder/file-upload/css/jquery.fileupload.css' %}">
    <link rel="stylesheet" href="{% static 'autograder/file-upload/css/jquery.fileupload-ui.css' %}">
    <!-- CSS adjustments for browsers with JavaScript disabled -->
    <noscript><link rel="stylesheet" href="{% static 'autograder/file-upload/css/jquery.fileupload-noscript.css' %}"></noscript>
    <noscript><link rel="stylesheet" href="{% static 'autograder/file-upload/css/jquery.fileupload-ui-noscript.css' %}"></noscript>

    <!-- The jQuery UI widget factory, can be omitted if jQuery UI is already included -->
    <script src="{% static 'autograder/file-upload/js/vendor/jquery.ui.widget.js' %}"></script>
    <!-- The Templates plugin is included to render the upload/download listings -->
    <script src="{% static 'autograder/file-upload/js/tmpl.min.js' %}"></script>
    <!-- The Load Image plugin is included for the preview images and image resizing functionality -->
    <script src="{% static 'autograder/file-upload/js/load-image.all.min.js' %}"></script>
    <!-- The Canvas to Blob plugin is included for image resizing functionality -->
    <!--<script src="//blueimp.github.io/JavaScript-Canvas-to-Blob/js/canvas-to-blob.min.js"></script>-->
    <!-- blueimp Gallery script -->
    <!--<script src="//blueimp.github.io/Gallery/js/jquery.blueimp-gallery.min.js"></script>-->
    <!-- The Iframe Transport is required for browsers without support for XHR file uploads -->
    <script src="{% static 'autograder/file-upload/js/jquery.iframe-transport.js' %}"></script>
    <!-- The basic File Upload plugin -->
    <script src="{% static 'autograder/file-upload/js/jquery.fileupload.js' %}"></script>
    <!-- The File Upload processing plugin -->
    <script src="{% static 'autograder/file-upload/js/jquery.fileupload-process.js' %}"></script>
    <!-- The File Upload image preview & resize plugin -->
    <script src="{% static 'autograder/file-upload/js/jquery.fileupload-image.js' %}"></script>
    <!-- The File Upload audio preview plugin -->
    <script src="{% static 'autograder/file-upload/js/jquery.fileupload-audio.js' %}"></script>
    <!-- The File Upload video preview plugin -->
    <script src="{% static 'autograder/file-upload/js/jquery.fileupload-video.js' %}"></script>
    <!-- The File Upload validation plugin -->
    <script src="{% static 'autograder/file-upload/js/jquery.fileupload-validate.js' %}"></script>
    <!-- The File Upload user interface plugin -->
    <script src="{% static 'autograder/file-upload/js/jquery.fileupload-ui.js' %}"></script>

    <!-- /File Upload -->

    <script src='https://www.jsviews.com/download/jsrender.min.js'></script>
    <script src="https://www.jsviews.com/download/sample-tag-controls/range/range.js"></script>

    <script src="{% static 'autograder/js/utilities.js' %}"></script>

    <script type="text/javascript" id='page-navigation'>

    'use strict';


    $(document).ready(function () {
        $(window).on('popstate', function (e) {
            load_view();
        });

        $.views.converters({
            to_local_date: function(date_str) {
                return new Date(date_str).toLocaleString();
            }
        });
    });

    function load_view()
    {
        console.log('load_view');
        // var pageName = getPageName();
        var current_path = window.location.pathname;
        // Offset the split and substring indices by one to ignore the leading
        // slash.
        var view_name = current_path.split('/')[1];
        var resource_url = current_path.substring(view_name.length + 1);

        if (view_name === '')
        {
            load_landing_page();
        }
        else if (view_name === 'semester')
        {
            load_semester_view(resource_url);
        }
        else if (view_name === 'project')
        {
            load_and_display_project_view(resource_url);
        }
        else if (view_name === 'submission')
        {
            load_submission_view(resource_url);
        }
        else
        {
            history.replaceState(null, '', '/');
            load_landing_page();
        }
    }

    function load_landing_page()
    {
        $.when(
            $.get({% url 'list-courses' %}), $.get({% url 'list-semesters' %})
        ).done(function(courses_result, semesters_result) {
            // console.log(courses_result[0]);
            // console.log(semesters_result[0]);
            var data = {
                'courses': courses_result[0],
                'semesters': semesters_result[0]
            };
            // console.log(data);
            render_and_fix_links('landing-page', data);
            // console.log($('#main-area'));
        });
    }

    function load_semester_view(semester_url)
    {
        // console.log('load_semester_view');
        // console.log(semester_url);
        $.get(semester_url, function(data, status) {
            // console.log(status);
            render_and_fix_links('view-semester', data);
        });
    }


    // function handle_file_input_change(files)
    // {
    //     console.log("don't gooooo changin'");
    //     console.log(files);
    //     console.log($('#file_input')[0].files);
    // }

    function load_submission_view(submission_url)
    {
        console.log('load_submission_view');
        $.get(submission_url).done(function(data, status) {
            // console.log(data);
            $.when(
                render_and_fix_links('view-submission', data)
            ).done(function() {
                // $('.file-link').click(function(event) {
                //     event.preventDefault();
                //     console.log($(this).attr('content-dest'));
                // });
            });
        });
    }

    function get_user_email()
    {
        var auth2 = gapi.auth2.getAuthInstance();
        var profile = auth2.currentUser.get().getBasicProfile();
        return profile.getEmail();
    }

    function render_and_fix_links(template_name, data, render_location, append)
    {
        if (render_location === undefined)
        {
            render_location = $('#main-area');
        }

        if (append === undefined)
        {
            append = false;
        }

        var deferred = $.Deferred();
        $.when(lazy_get_template(template_name)).done(function() {
            var tmpl = $.templates[template_name];
            // console.log(tmpl);
            // console.log(tmpl.render(data));
            var rendered = tmpl.render(data);
            if (append)
            {
                render_location.append(rendered);
            }
            else
            {
                render_location.html(rendered);
            }

            // Adapted from: http://www.codemag.com/article/1301091
            // Date accessed: 2015-08-20
            $("a[data-role='ajax']").click(function (e) {
                e.preventDefault();
                var pageName = $(this).attr("href");
                window.history.pushState(null, "", pageName);
                load_view();
            });
            deferred.resolve();
        });
        return deferred.promise();
    }

    // Adapted from: http://www.jsviews.com/#samples/jsr/composition/remote-tmpl
    function lazy_get_template(name)
    {
        // If the named remote template is not yet loaded and compiled
        // as a named template, fetch it. In either case, return a promise
        // (already resolved, if the template has already been loaded)
        var deferred = $.Deferred();
        if ($.templates[name])
        {
            deferred.resolve();
        }
        else
        {
            var url = '/static/autograder/jsrender-templates/' + name + '.tmpl'
            $.get(url).done(function(data, status) {
                // console.log(data);
                $.templates(name, data);
                deferred.resolve();
            });
        }
        return deferred.promise();
    }

    // Adapted from: http://benjamin-schweizer.de/jquerypostjson.html
    $.postJSON = function(url, data, callback) {
        return jQuery.ajax({
            'type': 'POST',
            'url': url,
            'contentType': 'application/json',
            'data': JSON.stringify(data),
            'dataType': 'json',
            'success': callback
        });
    };
    </script>
</head>
<body>

<div class='container'>
    <div class="g-signin2" data-onsuccess="onSignIn" data-theme="dark"></div>
    <button onclick='signOut();'>Sign out</button>

    <h1>The Autograder</h1>

    <div id='main-area' class='container'></div>
</div>

<script>
    function onSignIn(googleUser)
    {
        // Useful data for your client-side scripts:
        var profile = googleUser.getBasicProfile();
        // console.log("ID: " + profile.getId()); // Don't send this directly to your server!
        // console.log("Name: " + profile.getName());
        // console.log("Image URL: " + profile.getImageUrl());
        // console.log("Email: " + profile.getEmail());

        if (profile.getEmail().split('@')[1] != 'umich.edu')
        {
            alert('Please sign in with your "umich.edu" email address');
            gapi.auth2.getAuthInstance().signOut();
            return;
        }

        // The ID token you need to pass to your backend:
        var id_token = googleUser.getAuthResponse().id_token;
        // console.log("ID Token: " + id_token);

        login_to_server(id_token);
    }

    function login_to_server(id_token)
    {
        $.post(
            "{% url 'login' %}", {'idtoken': id_token}
        ).done(
            load_view
        ).fail(
            function(status, data) {
                console.log('login failure: ' + status + ' ' + data);
                signOut();
            }
        );
    }

</script>

<script>
    function signOut()
    {
        var auth2 = gapi.auth2.getAuthInstance();
        auth2.signOut().then(function () {
            console.log('User signed out.');
            history.pushState(null, "", '/');
            $('#main-area').html('');

            $.post("{% url 'logout' %}");
        });
    }

</script>

<script src="{% static 'autograder/js/register-group-view.js' %}"></script>
<script src="{% static 'autograder/js/view-project.js' %}"></script>

</body>
</html>

